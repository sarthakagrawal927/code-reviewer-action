<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Reviewer Control Plane</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Sora:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --ink: #101725;
        --muted: #5e6a84;
        --surface: #ffffff;
        --surface-soft: #f6f8ff;
        --line: #d9e1f3;
        --accent: #0068ff;
        --accent-strong: #0153cb;
        --warning: #cf6a00;
        --success: #1f8f5f;
        --danger: #c02828;
        --bg-a: #f4f7ff;
        --bg-b: #eefdf7;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Sora', sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 4% 8%, #dbe8ff 0, transparent 32%),
          radial-gradient(circle at 96% 96%, #d8f5e8 0, transparent 28%),
          linear-gradient(145deg, var(--bg-a), var(--bg-b));
        min-height: 100vh;
      }

      .shell {
        width: min(1400px, 96vw);
        margin: 24px auto 36px;
      }

      .hero {
        background: linear-gradient(124deg, #0f1f40, #13316f 55%, #1f5e8c);
        color: #eaf1ff;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 16px 40px rgba(8, 21, 52, 0.3);
        position: relative;
        overflow: hidden;
      }

      .hero::after {
        content: '';
        position: absolute;
        right: -100px;
        top: -80px;
        width: 260px;
        height: 260px;
        border-radius: 999px;
        background: linear-gradient(180deg, rgba(255, 196, 77, 0.36), rgba(255, 196, 77, 0));
        pointer-events: none;
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(1.6rem, 2.5vw, 2.25rem);
        line-height: 1.2;
      }

      .hero p {
        margin: 10px 0 0;
        color: #cdd8ff;
        max-width: 900px;
      }

      .badge-row {
        margin-top: 18px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .badge {
        font-size: 0.75rem;
        font-family: 'IBM Plex Mono', monospace;
        border: 1px solid rgba(235, 242, 255, 0.22);
        border-radius: 999px;
        padding: 6px 10px;
        color: #e9f0ff;
        background: rgba(255, 255, 255, 0.08);
      }

      .layout {
        margin-top: 18px;
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 14px;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 8px 24px rgba(28, 45, 87, 0.06);
      }

      .card h2 {
        margin: 0 0 10px;
        font-size: 1rem;
      }

      .card p.section-note {
        margin: 0 0 12px;
        color: var(--muted);
        font-size: 0.85rem;
      }

      .card.wide {
        grid-column: span 12;
      }

      .card.half {
        grid-column: span 6;
      }

      .card.third {
        grid-column: span 4;
      }

      @media (max-width: 1100px) {
        .card.half,
        .card.third {
          grid-column: span 12;
        }
      }

      .field-grid {
        display: grid;
        gap: 10px;
      }

      .field-grid.cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .field-grid.cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      @media (max-width: 760px) {
        .field-grid.cols-2,
        .field-grid.cols-3 {
          grid-template-columns: 1fr;
        }
      }

      label {
        display: block;
        font-size: 0.78rem;
        color: var(--muted);
        margin-bottom: 5px;
      }

      input,
      select,
      textarea,
      button {
        font: inherit;
      }

      input,
      select,
      textarea {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 9px 10px;
        background: #fff;
        color: var(--ink);
      }

      textarea {
        min-height: 84px;
        resize: vertical;
      }

      .btn-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      button {
        border: 1px solid transparent;
        border-radius: 10px;
        padding: 9px 12px;
        cursor: pointer;
        transition: 0.15s ease;
      }

      button.primary {
        background: var(--accent);
        color: white;
      }

      button.primary:hover {
        background: var(--accent-strong);
      }

      button.secondary {
        background: var(--surface-soft);
        border-color: var(--line);
        color: var(--ink);
      }

      button.warn {
        background: #fff4e8;
        border-color: #f2d4b2;
        color: var(--warning);
      }

      button.success {
        background: #e8f8f1;
        border-color: #c1ebd7;
        color: var(--success);
      }

      .inline {
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      .mono {
        font-family: 'IBM Plex Mono', monospace;
      }

      .status {
        margin-top: 10px;
        padding: 9px 10px;
        border-radius: 10px;
        font-size: 0.83rem;
        font-family: 'IBM Plex Mono', monospace;
      }

      .status.ok {
        background: #eaf9f2;
        border: 1px solid #bde7d1;
        color: #136843;
      }

      .status.warn {
        background: #fff6ea;
        border: 1px solid #f4d7ae;
        color: #9b5a00;
      }

      .status.error {
        background: #fff0f0;
        border: 1px solid #f1c2c2;
        color: #9d2222;
      }

      .data-box {
        margin-top: 10px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #f9fbff;
        max-height: 240px;
        overflow: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.82rem;
      }

      th,
      td {
        border-bottom: 1px solid #e8ecf7;
        padding: 7px 8px;
        text-align: left;
        vertical-align: top;
      }

      th {
        color: #425272;
        font-weight: 600;
        background: #f2f6ff;
        position: sticky;
        top: 0;
      }

      .json {
        margin: 0;
        padding: 10px;
        font-size: 0.78rem;
        white-space: pre-wrap;
        line-height: 1.5;
      }

      .footer-log {
        margin-top: 14px;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: #0f1d37;
        color: #d9e8ff;
      }

      .footer-log h3 {
        margin: 0 0 8px;
        font-size: 0.9rem;
      }

      .footer-log pre {
        margin: 0;
        max-height: 240px;
        overflow: auto;
        font-size: 0.76rem;
        font-family: 'IBM Plex Mono', monospace;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <section class="hero">
        <h1>Code Reviewer Control Plane</h1>
        <p>
          Local operator dashboard for v1 skeleton APIs: organization setup, repository wiring, rule tuning,
          drift detection, manual reconcile, and review triggering.
        </p>
        <div class="badge-row">
          <span class="badge">v1 local mode</span>
          <span class="badge">Tree-sitter indexing track</span>
          <span class="badge">manual drift + reconcile</span>
          <span class="badge">no persistence (in-memory store)</span>
        </div>
      </section>

      <main class="layout">
        <section class="card wide" id="connection-card">
          <h2>Connection</h2>
          <p class="section-note">Configure API base and optional bearer token. Settings are saved in your browser.</p>
          <div class="field-grid cols-3">
            <div>
              <label for="api-base-url">API Base URL</label>
              <input id="api-base-url" type="text" value="http://127.0.0.1:8080" />
            </div>
            <div>
              <label for="api-token">Auth Token (optional)</label>
              <input id="api-token" type="password" placeholder="Bearer token" />
            </div>
            <div>
              <label for="selected-org-global">Active Org Context</label>
              <select id="selected-org-global">
                <option value="">No org selected</option>
              </select>
            </div>
          </div>
          <div class="btn-row">
            <button class="primary" id="save-connection">Save Connection</button>
            <button class="secondary" id="test-health">Test /health</button>
            <button class="secondary" id="refresh-all">Refresh All Lists</button>
          </div>
          <div id="connection-status" class="status warn">Not connected yet.</div>
        </section>

        <section class="card half" id="orgs-card">
          <h2>Organizations</h2>
          <p class="section-note">Create org records and view all connected organizations.</p>
          <div class="field-grid cols-2">
            <div>
              <label for="org-slug">Slug</label>
              <input id="org-slug" type="text" placeholder="acme-inc" />
            </div>
            <div>
              <label for="org-display-name">Display Name</label>
              <input id="org-display-name" type="text" placeholder="Acme Inc" />
            </div>
            <div>
              <label for="org-github-id">GitHub Org ID (optional)</label>
              <input id="org-github-id" type="text" placeholder="123456" />
            </div>
            <div>
              <label for="org-installation-id">GitHub Installation ID (optional)</label>
              <input id="org-installation-id" type="text" placeholder="987654" />
            </div>
          </div>
          <div class="btn-row">
            <button class="primary" id="create-org">Create Org</button>
            <button class="secondary" id="load-orgs">Reload Orgs</button>
          </div>
          <div class="data-box">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Slug</th>
                  <th>Install</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="orgs-table-body"></tbody>
            </table>
          </div>
        </section>

        <section class="card half" id="members-card">
          <h2>Members</h2>
          <p class="section-note">Manage members under an organization.</p>
          <div class="field-grid cols-2">
            <div>
              <label for="members-org-id">Organization</label>
              <select id="members-org-id"></select>
            </div>
            <div>
              <label for="member-login">GitHub Login</label>
              <input id="member-login" type="text" placeholder="octocat" />
            </div>
            <div>
              <label for="member-user-id">GitHub User ID</label>
              <input id="member-user-id" type="text" placeholder="1001" />
            </div>
            <div>
              <label for="member-role">Role</label>
              <select id="member-role">
                <option value="member">member</option>
                <option value="admin">admin</option>
                <option value="owner">owner</option>
              </select>
            </div>
            <div>
              <label for="member-status">Status</label>
              <select id="member-status">
                <option value="active">active</option>
                <option value="invited">invited</option>
                <option value="removed">removed</option>
              </select>
            </div>
          </div>
          <div class="btn-row">
            <button class="primary" id="create-member">Add Member</button>
            <button class="secondary" id="load-members">Reload Members</button>
          </div>
          <div class="data-box">
            <table>
              <thead>
                <tr>
                  <th>Login</th>
                  <th>User ID</th>
                  <th>Role</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="members-table-body"></tbody>
            </table>
          </div>
        </section>

        <section class="card wide" id="repos-card">
          <h2>Repositories</h2>
          <p class="section-note">Attach repositories to an org (workspaceId = orgId in this skeleton).</p>
          <div class="field-grid cols-3">
            <div>
              <label for="quick-connect-org-id">Quick Connect Org</label>
              <select id="quick-connect-org-id"></select>
            </div>
            <div>
              <label for="quick-connect-repo">GitHub Repo</label>
              <input
                id="quick-connect-repo"
                type="text"
                placeholder="owner/repo or https://github.com/owner/repo"
              />
            </div>
            <div>
              <label for="quick-connect-branch">Default Branch</label>
              <input id="quick-connect-branch" type="text" value="main" />
            </div>
          </div>
          <div class="btn-row">
            <button class="success" id="quick-connect-repo-btn">Connect GitHub Repo</button>
          </div>
          <div class="field-grid cols-3">
            <div>
              <label for="repo-workspace-id">Workspace / Org ID</label>
              <input id="repo-workspace-id" type="text" placeholder="org_1" />
            </div>
            <div>
              <label for="repo-owner">Owner</label>
              <input id="repo-owner" type="text" placeholder="my-org" />
            </div>
            <div>
              <label for="repo-name">Repo Name</label>
              <input id="repo-name" type="text" placeholder="web-annotator" />
            </div>
            <div>
              <label for="repo-installation-id">Installation ID (optional)</label>
              <input id="repo-installation-id" type="text" placeholder="987654" />
            </div>
            <div>
              <label for="repo-default-branch">Default Branch</label>
              <input id="repo-default-branch" type="text" value="main" />
            </div>
          </div>
          <div class="btn-row">
            <button class="primary" id="create-repo">Create Repo</button>
            <button class="secondary" id="load-repos">Reload Repos</button>
          </div>
          <div class="data-box">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Full Name</th>
                  <th>Workspace</th>
                  <th>Branch</th>
                </tr>
              </thead>
              <tbody id="repos-table-body"></tbody>
            </table>
          </div>
        </section>

        <section class="card half" id="rules-card">
          <h2>Rules</h2>
          <p class="section-note">Load and update repository review policy.</p>
          <div class="field-grid cols-2">
            <div>
              <label for="rules-repo-id">Repository ID</label>
              <select id="rules-repo-id"></select>
            </div>
            <div class="inline" style="margin-top: 24px">
              <input id="rule-fail-on-findings" type="checkbox" />
              <label for="rule-fail-on-findings" style="margin: 0">Fail on findings</label>
            </div>
            <div>
              <label for="rule-fail-severity">Fail On Severity</label>
              <select id="rule-fail-severity">
                <option>low</option>
                <option>medium</option>
                <option selected>high</option>
                <option>critical</option>
              </select>
            </div>
            <div>
              <label for="rule-max-inline">Max Inline Findings</label>
              <input id="rule-max-inline" type="number" min="0" max="20" value="5" />
            </div>
            <div>
              <label for="rule-min-inline-severity">Min Inline Severity</label>
              <select id="rule-min-inline-severity">
                <option>low</option>
                <option selected>medium</option>
                <option>high</option>
                <option>critical</option>
              </select>
            </div>
            <div>
              <label for="rule-review-tone">Review Tone</label>
              <select id="rule-review-tone">
                <option>strict</option>
                <option selected>balanced</option>
                <option>friendly</option>
              </select>
            </div>
          </div>
          <div class="field-grid cols-2" style="margin-top: 10px">
            <div>
              <label for="rule-blocked-patterns">Blocked Patterns (comma-separated)</label>
              <textarea id="rule-blocked-patterns" placeholder="console.log, FIXME"></textarea>
            </div>
            <div>
              <label for="rule-required-checks">Required Checks (comma-separated)</label>
              <textarea id="rule-required-checks" placeholder="lint, test"></textarea>
            </div>
          </div>
          <div class="field-grid cols-3" style="margin-top: 8px">
            <label class="inline"><input id="threshold-low" type="checkbox" checked /> low enabled</label>
            <label class="inline"><input id="threshold-medium" type="checkbox" checked /> medium enabled</label>
            <label class="inline"><input id="threshold-high" type="checkbox" checked /> high enabled</label>
          </div>
          <div class="inline" style="margin-top: 6px">
            <input id="threshold-critical" type="checkbox" checked />
            <label for="threshold-critical" style="margin: 0">critical enabled</label>
          </div>
          <div class="btn-row">
            <button class="secondary" id="load-rules">Load Rules</button>
            <button class="primary" id="save-rules">Save Rules</button>
          </div>
          <div class="data-box">
            <pre class="json" id="rules-result">No rules loaded.</pre>
          </div>
        </section>

        <section class="card half" id="reviews-card">
          <h2>Reviews</h2>
          <p class="section-note">Trigger review jobs and inspect review run queue state.</p>
          <div class="field-grid cols-2">
            <div>
              <label for="reviews-repo-id">Repository ID</label>
              <select id="reviews-repo-id"></select>
            </div>
            <div>
              <label for="trigger-pr-number">PR Number</label>
              <input id="trigger-pr-number" type="number" min="1" value="1" />
            </div>
            <div>
              <label for="trigger-head-sha">Head SHA</label>
              <input id="trigger-head-sha" type="text" placeholder="abc123def" />
            </div>
          </div>
          <div class="btn-row">
            <button class="primary" id="trigger-review">Trigger Review</button>
            <button class="secondary" id="load-reviews">Reload Runs</button>
          </div>
          <div class="data-box">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Repo</th>
                  <th>PR</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="reviews-table-body"></tbody>
            </table>
          </div>
        </section>

        <section class="card half" id="drift-card">
          <h2>Drift Check</h2>
          <p class="section-note">Run live GitHub drift checks, then trigger manual reconcile if needed.</p>
          <div class="field-grid cols-2">
            <div>
              <label for="drift-org-id">Organization</label>
              <select id="drift-org-id"></select>
            </div>
            <div>
              <label for="expected-repo-count">Expected Repo Count (optional)</label>
              <input id="expected-repo-count" type="number" min="0" />
            </div>
            <div>
              <label for="expected-member-count">Expected Member Count (optional)</label>
              <input id="expected-member-count" type="number" min="0" />
            </div>
            <div>
              <label for="expected-installation-id">Expected Installation ID (optional)</label>
              <input id="expected-installation-id" type="text" />
            </div>
          </div>
          <div class="inline" style="margin-top: 8px">
            <input id="reconcile-force" type="checkbox" />
            <label for="reconcile-force" style="margin: 0">Force reconcile even if no drift</label>
          </div>
          <div class="btn-row">
            <button class="primary" id="run-drift-check">Run Drift Check</button>
            <button class="secondary" id="load-drift-checks">Load Drift Checks</button>
            <button class="warn" id="run-reconcile">Queue Reconcile</button>
            <button class="secondary" id="load-reconcile-runs">Load Reconcile Runs</button>
          </div>
          <div class="data-box">
            <pre class="json" id="drift-result">No drift data yet.</pre>
          </div>
        </section>

        <section class="card half" id="webhooks-card">
          <h2>Webhook Events</h2>
          <p class="section-note">Inspect recorded webhook events and send a simulated one for testing.</p>
          <div class="field-grid cols-3">
            <div>
              <label for="webhook-event-name">Event Name</label>
              <input id="webhook-event-name" type="text" value="pull_request" />
            </div>
            <div>
              <label for="webhook-delivery-id">Delivery ID</label>
              <input id="webhook-delivery-id" type="text" placeholder="delivery-1" />
            </div>
            <div>
              <label for="webhook-signature">Signature (optional)</label>
              <input id="webhook-signature" type="text" placeholder="sha256=..." />
            </div>
          </div>
          <div style="margin-top: 8px">
            <label for="webhook-payload">Webhook Payload (JSON)</label>
            <textarea id="webhook-payload">{
  "action": "opened",
  "pull_request": { "number": 1 }
}</textarea>
          </div>
          <div class="btn-row">
            <button class="success" id="simulate-webhook">Simulate Webhook</button>
            <button class="secondary" id="load-webhook-events">Load Events</button>
          </div>
          <div class="data-box">
            <pre class="json" id="webhook-result">No webhook events loaded.</pre>
          </div>
        </section>
      </main>

      <section class="footer-log">
        <h3>Activity Log</h3>
        <pre id="activity-log"></pre>
      </section>
    </div>

    <script>
      const STORE_KEYS = {
        apiBaseUrl: 'cr_dashboard_api_base_url',
        apiToken: 'cr_dashboard_api_token'
      };

      const state = {
        orgs: [],
        repos: []
      };

      const refs = {
        apiBaseUrl: document.getElementById('api-base-url'),
        apiToken: document.getElementById('api-token'),
        connectionStatus: document.getElementById('connection-status'),
        activityLog: document.getElementById('activity-log'),
        selectedOrgGlobal: document.getElementById('selected-org-global'),

        orgSlug: document.getElementById('org-slug'),
        orgDisplayName: document.getElementById('org-display-name'),
        orgGithubId: document.getElementById('org-github-id'),
        orgInstallationId: document.getElementById('org-installation-id'),
        orgsTableBody: document.getElementById('orgs-table-body'),

        membersOrgId: document.getElementById('members-org-id'),
        memberLogin: document.getElementById('member-login'),
        memberUserId: document.getElementById('member-user-id'),
        memberRole: document.getElementById('member-role'),
        memberStatus: document.getElementById('member-status'),
        membersTableBody: document.getElementById('members-table-body'),

        repoWorkspaceId: document.getElementById('repo-workspace-id'),
        repoOwner: document.getElementById('repo-owner'),
        repoName: document.getElementById('repo-name'),
        repoInstallationId: document.getElementById('repo-installation-id'),
        repoDefaultBranch: document.getElementById('repo-default-branch'),
        quickConnectOrgId: document.getElementById('quick-connect-org-id'),
        quickConnectRepo: document.getElementById('quick-connect-repo'),
        quickConnectBranch: document.getElementById('quick-connect-branch'),
        reposTableBody: document.getElementById('repos-table-body'),

        rulesRepoId: document.getElementById('rules-repo-id'),
        ruleFailOnFindings: document.getElementById('rule-fail-on-findings'),
        ruleFailSeverity: document.getElementById('rule-fail-severity'),
        ruleMaxInline: document.getElementById('rule-max-inline'),
        ruleMinInlineSeverity: document.getElementById('rule-min-inline-severity'),
        ruleReviewTone: document.getElementById('rule-review-tone'),
        ruleBlockedPatterns: document.getElementById('rule-blocked-patterns'),
        ruleRequiredChecks: document.getElementById('rule-required-checks'),
        thresholdLow: document.getElementById('threshold-low'),
        thresholdMedium: document.getElementById('threshold-medium'),
        thresholdHigh: document.getElementById('threshold-high'),
        thresholdCritical: document.getElementById('threshold-critical'),
        rulesResult: document.getElementById('rules-result'),

        reviewsRepoId: document.getElementById('reviews-repo-id'),
        triggerPrNumber: document.getElementById('trigger-pr-number'),
        triggerHeadSha: document.getElementById('trigger-head-sha'),
        reviewsTableBody: document.getElementById('reviews-table-body'),

        driftOrgId: document.getElementById('drift-org-id'),
        expectedRepoCount: document.getElementById('expected-repo-count'),
        expectedMemberCount: document.getElementById('expected-member-count'),
        expectedInstallationId: document.getElementById('expected-installation-id'),
        reconcileForce: document.getElementById('reconcile-force'),
        driftResult: document.getElementById('drift-result'),

        webhookEventName: document.getElementById('webhook-event-name'),
        webhookDeliveryId: document.getElementById('webhook-delivery-id'),
        webhookSignature: document.getElementById('webhook-signature'),
        webhookPayload: document.getElementById('webhook-payload'),
        webhookResult: document.getElementById('webhook-result')
      };

      function now() {
        return new Date().toLocaleTimeString();
      }

      function log(message, payload) {
        const line = `[${now()}] ${message}`;
        if (payload !== undefined) {
          refs.activityLog.textContent = `${line}\n${JSON.stringify(payload, null, 2)}\n\n${refs.activityLog.textContent}`;
        } else {
          refs.activityLog.textContent = `${line}\n${refs.activityLog.textContent}`;
        }
      }

      function readConnection() {
        const baseUrl = refs.apiBaseUrl.value.trim().replace(/\/$/, '');
        const token = refs.apiToken.value.trim();
        return { baseUrl, token };
      }

      function setConnectionStatus(text, kind = 'warn') {
        refs.connectionStatus.className = `status ${kind}`;
        refs.connectionStatus.textContent = text;
      }

      async function apiRequest(path, options = {}) {
        const { baseUrl, token } = readConnection();
        if (!baseUrl) {
          throw new Error('API base URL is required.');
        }

        const headers = Object.assign({}, options.headers || {});
        if (token) {
          headers.authorization = `Bearer ${token}`;
        }

        let body;
        if (options.body !== undefined) {
          headers['content-type'] = 'application/json';
          body = JSON.stringify(options.body);
        }

        const response = await fetch(`${baseUrl}${path}`, {
          method: options.method || 'GET',
          headers,
          body
        });

        const text = await response.text();
        let data;
        try {
          data = text ? JSON.parse(text) : null;
        } catch {
          data = { raw: text };
        }

        if (!response.ok) {
          const message = data && data.message ? data.message : `Request failed: ${response.status}`;
          const error = new Error(message);
          error.status = response.status;
          error.payload = data;
          throw error;
        }

        return data;
      }

      function parseCsv(text) {
        return text
          .split(',')
          .map(value => value.trim())
          .filter(Boolean);
      }

      function safeNumber(value) {
        if (value === '' || value === null || value === undefined) {
          return undefined;
        }

        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : undefined;
      }

      function fillOrgSelects() {
        const selects = [refs.selectedOrgGlobal, refs.membersOrgId, refs.driftOrgId, refs.quickConnectOrgId];
        const selected = refs.selectedOrgGlobal.value;

        for (const select of selects) {
          const previous = select.value;
          const options = ['<option value="">Select org</option>']
            .concat(
              state.orgs.map(org => `<option value="${org.id}">${org.displayName} (${org.id})</option>`)
            )
            .join('');
          select.innerHTML = options;
          select.value = previous || selected || '';
        }

        if (!refs.repoWorkspaceId.value && refs.selectedOrgGlobal.value) {
          refs.repoWorkspaceId.value = refs.selectedOrgGlobal.value;
        }
      }

      function parseGitHubRepoInput(value) {
        const raw = value.trim();
        if (!raw) {
          throw new Error('Repository input is required.');
        }

        let normalized = raw;
        try {
          const url = new URL(raw);
          if (!/github\.com$/i.test(url.hostname)) {
            throw new Error('Only github.com URLs are accepted.');
          }

          normalized = url.pathname;
        } catch {
          // Keep raw input and parse as owner/name.
        }

        normalized = normalized.replace(/^\//, '').replace(/\.git$/i, '').replace(/\/$/, '');
        const parts = normalized.split('/').filter(Boolean);
        if (parts.length < 2) {
          throw new Error('Use owner/repo format or a full GitHub URL.');
        }

        return {
          owner: parts[0],
          name: parts[1]
        };
      }

      function fillRepoSelects() {
        const selects = [refs.rulesRepoId, refs.reviewsRepoId];
        for (const select of selects) {
          const previous = select.value;
          const options = ['<option value="">Select repository</option>']
            .concat(
              state.repos.map(repo => `<option value="${repo.id}">${repo.fullName} (${repo.id})</option>`)
            )
            .join('');
          select.innerHTML = options;
          select.value = previous || '';
        }
      }

      function renderOrgs() {
        refs.orgsTableBody.innerHTML = state.orgs
          .map(
            org => `<tr>
              <td class="mono">${org.id}</td>
              <td>${org.slug}</td>
              <td class="mono">${org.githubInstallationId || '-'}</td>
              <td><button class="secondary" data-org-id="${org.id}">Use</button></td>
            </tr>`
          )
          .join('');
      }

      function renderRepos() {
        refs.reposTableBody.innerHTML = state.repos
          .map(
            repo => `<tr>
              <td class="mono">${repo.id}</td>
              <td>${repo.fullName}</td>
              <td class="mono">${repo.workspaceId}</td>
              <td class="mono">${repo.defaultBranch || '-'}</td>
            </tr>`
          )
          .join('');
      }

      async function loadHealth() {
        const data = await apiRequest('/health');
        setConnectionStatus(`Connected to ${data.service} at ${data.timestamp}`, 'ok');
        log('Health check succeeded.', data);
      }

      async function loadOrgs() {
        const data = await apiRequest('/v1/orgs');
        state.orgs = data.organizations || [];
        renderOrgs();
        fillOrgSelects();
        log('Loaded organizations.', { count: state.orgs.length });
      }

      async function createOrg() {
        const payload = {
          slug: refs.orgSlug.value.trim(),
          displayName: refs.orgDisplayName.value.trim() || undefined,
          githubOrgId: refs.orgGithubId.value.trim() || undefined,
          githubInstallationId: refs.orgInstallationId.value.trim() || undefined
        };

        const data = await apiRequest('/v1/orgs', { method: 'POST', body: payload });
        log('Created organization.', data);
        await loadOrgs();
      }

      async function loadMembers() {
        const orgId = refs.membersOrgId.value;
        if (!orgId) {
          throw new Error('Select an organization for members.');
        }

        const data = await apiRequest(`/v1/orgs/${encodeURIComponent(orgId)}/members`);
        refs.membersTableBody.innerHTML = (data.members || [])
          .map(
            member => `<tr>
              <td>${member.githubLogin}</td>
              <td class="mono">${member.githubUserId}</td>
              <td>${member.role}</td>
              <td>${member.status}</td>
            </tr>`
          )
          .join('');
        log('Loaded members.', { orgId, count: (data.members || []).length });
      }

      async function createMember() {
        const orgId = refs.membersOrgId.value;
        if (!orgId) {
          throw new Error('Select an organization for member creation.');
        }

        const payload = {
          githubUserId: refs.memberUserId.value.trim(),
          githubLogin: refs.memberLogin.value.trim(),
          role: refs.memberRole.value,
          status: refs.memberStatus.value
        };

        const data = await apiRequest(`/v1/orgs/${encodeURIComponent(orgId)}/members`, {
          method: 'POST',
          body: payload
        });
        log('Created member.', data);
        await loadMembers();
      }

      async function loadRepos() {
        const data = await apiRequest('/v1/repositories');
        state.repos = data.repositories || [];
        renderRepos();
        fillRepoSelects();
        log('Loaded repositories.', { count: state.repos.length });
      }

      async function createRepo() {
        const payload = {
          workspaceId: refs.repoWorkspaceId.value.trim(),
          owner: refs.repoOwner.value.trim(),
          name: refs.repoName.value.trim(),
          installationId: refs.repoInstallationId.value.trim() || undefined,
          defaultBranch: refs.repoDefaultBranch.value.trim() || 'main'
        };

        const data = await apiRequest('/v1/repositories', { method: 'POST', body: payload });
        log('Created repository.', data);
        await loadRepos();
      }

      async function quickConnectRepo() {
        const workspaceId = refs.quickConnectOrgId.value || refs.selectedOrgGlobal.value || refs.repoWorkspaceId.value.trim();
        if (!workspaceId) {
          throw new Error('Select an org first for quick connect.');
        }

        const parsed = parseGitHubRepoInput(refs.quickConnectRepo.value);
        const payload = {
          workspaceId,
          owner: parsed.owner,
          name: parsed.name,
          defaultBranch: refs.quickConnectBranch.value.trim() || 'main'
        };

        const data = await apiRequest('/v1/repositories', { method: 'POST', body: payload });
        log('Quick connected repository.', data);

        refs.repoWorkspaceId.value = workspaceId;
        refs.repoOwner.value = parsed.owner;
        refs.repoName.value = parsed.name;
        refs.repoDefaultBranch.value = payload.defaultBranch;

        await loadRepos();
      }

      function rulesPayload() {
        return {
          failOnFindings: refs.ruleFailOnFindings.checked,
          failOnSeverity: refs.ruleFailSeverity.value,
          maxInlineFindings: Number(refs.ruleMaxInline.value || 5),
          minInlineSeverity: refs.ruleMinInlineSeverity.value,
          reviewTone: refs.ruleReviewTone.value,
          blockedPatterns: parseCsv(refs.ruleBlockedPatterns.value),
          requiredChecks: parseCsv(refs.ruleRequiredChecks.value),
          severityThresholds: {
            low: refs.thresholdLow.checked,
            medium: refs.thresholdMedium.checked,
            high: refs.thresholdHigh.checked,
            critical: refs.thresholdCritical.checked
          }
        };
      }

      function applyRulesToForm(config) {
        refs.ruleFailOnFindings.checked = Boolean(config.failOnFindings);
        refs.ruleFailSeverity.value = config.failOnSeverity || 'high';
        refs.ruleMaxInline.value = String(config.maxInlineFindings ?? 5);
        refs.ruleMinInlineSeverity.value = config.minInlineSeverity || 'medium';
        refs.ruleReviewTone.value = config.reviewTone || 'balanced';
        refs.ruleBlockedPatterns.value = (config.blockedPatterns || []).join(', ');
        refs.ruleRequiredChecks.value = (config.requiredChecks || []).join(', ');
        refs.thresholdLow.checked = Boolean(config.severityThresholds?.low ?? true);
        refs.thresholdMedium.checked = Boolean(config.severityThresholds?.medium ?? true);
        refs.thresholdHigh.checked = Boolean(config.severityThresholds?.high ?? true);
        refs.thresholdCritical.checked = Boolean(config.severityThresholds?.critical ?? true);
      }

      async function loadRules() {
        const repoId = refs.rulesRepoId.value;
        if (!repoId) {
          throw new Error('Select a repository for rules.');
        }

        const data = await apiRequest(`/v1/rules/${encodeURIComponent(repoId)}`);
        refs.rulesResult.textContent = JSON.stringify(data, null, 2);
        if (data.config) {
          applyRulesToForm(data.config);
        }
        log('Loaded rules config.', data);
      }

      async function saveRules() {
        const repoId = refs.rulesRepoId.value;
        if (!repoId) {
          throw new Error('Select a repository for rules.');
        }

        const payload = rulesPayload();
        const data = await apiRequest(`/v1/rules/${encodeURIComponent(repoId)}`, {
          method: 'PUT',
          body: payload
        });
        refs.rulesResult.textContent = JSON.stringify(data, null, 2);
        log('Saved rules config.', data);
      }

      async function loadReviews() {
        const repoId = refs.reviewsRepoId.value;
        const suffix = repoId ? `?repositoryId=${encodeURIComponent(repoId)}` : '';
        const data = await apiRequest(`/v1/reviews${suffix}`);
        refs.reviewsTableBody.innerHTML = (data.runs || [])
          .map(
            run => `<tr>
              <td class="mono">${run.id}</td>
              <td class="mono">${run.repositoryId}</td>
              <td>${run.prNumber}</td>
              <td>${run.status}</td>
            </tr>`
          )
          .join('');
        log('Loaded review runs.', { count: (data.runs || []).length });
      }

      async function triggerReview() {
        const repoId = refs.reviewsRepoId.value;
        if (!repoId) {
          throw new Error('Select a repository before triggering review.');
        }

        const payload = {
          repositoryId: repoId,
          prNumber: Number(refs.triggerPrNumber.value || 0),
          headSha: refs.triggerHeadSha.value.trim()
        };

        const data = await apiRequest('/v1/reviews/trigger', {
          method: 'POST',
          body: payload
        });
        log('Triggered review run.', data);
        await loadReviews();
      }

      function driftPayload() {
        return {
          expectedRepositoryCount: safeNumber(refs.expectedRepoCount.value),
          expectedMemberCount: safeNumber(refs.expectedMemberCount.value),
          expectedInstallationId: refs.expectedInstallationId.value.trim() || undefined
        };
      }

      async function runDriftCheck() {
        const orgId = refs.driftOrgId.value;
        if (!orgId) {
          throw new Error('Select an organization for drift checks.');
        }

        const data = await apiRequest(`/v1/orgs/${encodeURIComponent(orgId)}/drift/check`, {
          method: 'POST',
          body: driftPayload()
        });
        refs.driftResult.textContent = JSON.stringify(data, null, 2);
        log('Ran drift check.', data);
      }

      async function loadDriftChecks() {
        const orgId = refs.driftOrgId.value;
        if (!orgId) {
          throw new Error('Select an organization for drift check history.');
        }

        const data = await apiRequest(`/v1/orgs/${encodeURIComponent(orgId)}/drift/check`);
        refs.driftResult.textContent = JSON.stringify(data, null, 2);
        log('Loaded drift checks.', data);
      }

      async function runReconcile() {
        const orgId = refs.driftOrgId.value;
        if (!orgId) {
          throw new Error('Select an organization for reconcile.');
        }

        const payload = {
          force: refs.reconcileForce.checked
        };
        const data = await apiRequest(`/v1/orgs/${encodeURIComponent(orgId)}/reconcile`, {
          method: 'POST',
          body: payload
        });
        refs.driftResult.textContent = JSON.stringify(data, null, 2);
        log('Queued reconcile run.', data);
      }

      async function loadReconcileRuns() {
        const orgId = refs.driftOrgId.value;
        if (!orgId) {
          throw new Error('Select an organization for reconcile history.');
        }

        const data = await apiRequest(`/v1/orgs/${encodeURIComponent(orgId)}/reconcile`);
        refs.driftResult.textContent = JSON.stringify(data, null, 2);
        log('Loaded reconcile runs.', data);
      }

      async function simulateWebhook() {
        const payloadText = refs.webhookPayload.value.trim();
        const payload = payloadText ? JSON.parse(payloadText) : {};
        const deliveryId = refs.webhookDeliveryId.value.trim() || `delivery-${Date.now()}`;

        const headers = {
          'x-github-event': refs.webhookEventName.value.trim() || 'pull_request',
          'x-github-delivery': deliveryId
        };

        const signature = refs.webhookSignature.value.trim();
        if (signature) {
          headers['x-hub-signature-256'] = signature;
        }

        const data = await apiRequest('/webhooks/github', {
          method: 'POST',
          headers,
          body: payload
        });
        refs.webhookResult.textContent = JSON.stringify(data, null, 2);
        log('Simulated webhook.', data);
      }

      async function loadWebhookEvents() {
        const data = await apiRequest('/v1/webhooks/events');
        refs.webhookResult.textContent = JSON.stringify(data, null, 2);
        log('Loaded webhook events.', { count: (data.events || []).length });
      }

      async function refreshAll() {
        await Promise.all([loadOrgs(), loadRepos()]);
      }

      function saveConnection() {
        const { baseUrl, token } = readConnection();
        localStorage.setItem(STORE_KEYS.apiBaseUrl, baseUrl);
        localStorage.setItem(STORE_KEYS.apiToken, token);
        setConnectionStatus(`Saved connection for ${baseUrl}`, 'ok');
        log('Saved connection settings.');
      }

      function loadConnectionFromStorage() {
        const baseUrl = localStorage.getItem(STORE_KEYS.apiBaseUrl);
        const token = localStorage.getItem(STORE_KEYS.apiToken);
        if (baseUrl) {
          refs.apiBaseUrl.value = baseUrl;
        }
        if (token) {
          refs.apiToken.value = token;
        }
      }

      function handleError(context, error) {
        const message = error && error.message ? error.message : 'Unknown error';
        setConnectionStatus(`${context}: ${message}`, 'error');
        log(`${context} failed.`, error && error.payload ? error.payload : { message });
      }

      function bindAction(buttonId, handler, context) {
        document.getElementById(buttonId).addEventListener('click', async () => {
          try {
            await handler();
          } catch (error) {
            handleError(context, error);
          }
        });
      }

      function bindEvents() {
        bindAction('save-connection', saveConnection, 'Save connection');
        bindAction('test-health', loadHealth, 'Health check');
        bindAction('refresh-all', refreshAll, 'Refresh all');

        bindAction('create-org', createOrg, 'Create org');
        bindAction('load-orgs', loadOrgs, 'Load orgs');

        bindAction('create-member', createMember, 'Create member');
        bindAction('load-members', loadMembers, 'Load members');

        bindAction('create-repo', createRepo, 'Create repo');
        bindAction('quick-connect-repo-btn', quickConnectRepo, 'Quick connect repo');
        bindAction('load-repos', loadRepos, 'Load repos');

        bindAction('load-rules', loadRules, 'Load rules');
        bindAction('save-rules', saveRules, 'Save rules');

        bindAction('trigger-review', triggerReview, 'Trigger review');
        bindAction('load-reviews', loadReviews, 'Load reviews');

        bindAction('run-drift-check', runDriftCheck, 'Run drift check');
        bindAction('load-drift-checks', loadDriftChecks, 'Load drift checks');
        bindAction('run-reconcile', runReconcile, 'Run reconcile');
        bindAction('load-reconcile-runs', loadReconcileRuns, 'Load reconcile runs');

        bindAction('simulate-webhook', simulateWebhook, 'Simulate webhook');
        bindAction('load-webhook-events', loadWebhookEvents, 'Load webhook events');

        refs.selectedOrgGlobal.addEventListener('change', () => {
          const orgId = refs.selectedOrgGlobal.value;
          refs.membersOrgId.value = orgId;
          refs.driftOrgId.value = orgId;
          if (orgId) {
            refs.repoWorkspaceId.value = orgId;
          }
        });

        refs.orgsTableBody.addEventListener('click', event => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) {
            return;
          }

          const button = target.closest('button[data-org-id]');
          if (!button) {
            return;
          }

          const orgId = button.getAttribute('data-org-id') || '';
          refs.selectedOrgGlobal.value = orgId;
          refs.membersOrgId.value = orgId;
          refs.driftOrgId.value = orgId;
          refs.repoWorkspaceId.value = orgId;
          log('Set active organization context.', { orgId });
        });
      }

      async function boot() {
        loadConnectionFromStorage();
        bindEvents();

        try {
          await loadHealth();
          await refreshAll();
        } catch (error) {
          handleError('Boot', error);
        }
      }

      boot();
    </script>
  </body>
</html>
